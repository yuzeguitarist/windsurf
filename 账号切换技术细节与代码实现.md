# Windsurf账号切换技术细节与代码实现

## 📌 核心问题解答

### Q1: 程序如何切换账号？

**答**: 通过修改Windsurf配置目录中的SQLite数据库（state.vscdb）和JSON配置文件，更新认证token和用户信息，然后触发窗口重载。

### Q2: 具体修改了哪些文件？

**答**: 主要修改3个关键文件：
1. `User/globalStorage/state.vscdb` - SQLite数据库
2. `User/settings.json` - 用户配置
3. 扩展自身的存储 - VS Code Extension Storage API

### Q3: 修改了哪些行？

**答**: 由于Windsurf是闭源且混淆的，无法给出精确行号，但修改的是数据库中的键值对，而不是代码行。

### Q4: 修改成什么格式？

**答**: JSON格式（配置文件）和 SQLite数据库记录（键值对）

---

## 🔬 详细技术实现

### 1. 账号切换完整代码流程（反推）

```javascript
/**
 * 账号切换主函数
 * @param {Object} accountInfo - 账号信息对象
 */
async function switchAccount(accountInfo) {
  try {
    // ===== 第一步: 验证账号信息 =====
    if (!accountInfo || !accountInfo.token) {
      throw new Error('Invalid account info');
    }

    // ===== 第二步: 获取Windsurf配置目录 =====
    const configDir = getWindsurfConfigDirectory();
    console.log('Config directory:', configDir);
    
    // ===== 第三步: 修改SQLite数据库 =====
    await updateStateDatabaseInternal(configDir, accountInfo);
    
    // ===== 第四步: 更新JSON配置 =====
    await updateJsonConfiguration(configDir, accountInfo);
    
    // ===== 第五步: 更新插件内部状态 =====
    await updateExtensionState(accountInfo);
    
    // ===== 第六步: 同步到远程服务器（可选） =====
    if (accountInfo.syncEnabled) {
      await syncToRemoteServer(accountInfo);
    }
    
    // ===== 第七步: 触发Windsurf重新加载 =====
    await reloadWindsurf();
    
    // ===== 第八步: 显示成功消息 =====
    showSuccessMessage(`已切换到账号: ${accountInfo.email}`);
    
  } catch (error) {
    console.error('Account switch failed:', error);
    showErrorMessage('账号切换失败: ' + error.message);
  }
}

/**
 * 获取Windsurf配置目录
 * @returns {string} 配置目录路径
 */
function getWindsurfConfigDirectory() {
  const os = require('os');
  const path = require('path');
  const platform = process.platform;
  
  let configPath;
  
  switch (platform) {
    case 'win32':
      // Windows: C:\Users\{username}\AppData\Roaming\Windsurf
      configPath = path.join(process.env.APPDATA, 'Windsurf');
      break;
      
    case 'darwin':
      // macOS: /Users/{username}/Library/Application Support/Windsurf
      configPath = path.join(
        os.homedir(),
        'Library',
        'Application Support',
        'Windsurf'
      );
      break;
      
    case 'linux':
      // Linux: /home/{username}/.config/Windsurf
      configPath = path.join(
        os.homedir(),
        '.config',
        'Windsurf'
      );
      break;
      
    default:
      throw new Error(`Unsupported platform: ${platform}`);
  }
  
  return configPath;
}

/**
 * 更新SQLite数据库
 * @param {string} configDir - 配置目录
 * @param {Object} accountInfo - 账号信息
 */
async function updateStateDatabaseInternal(configDir, accountInfo) {
  const path = require('path');
  const sqlite3 = require('sqlite3').verbose();
  
  // 数据库文件路径
  const dbPath = path.join(configDir, 'User', 'globalStorage', 'state.vscdb');
  
  return new Promise((resolve, reject) => {
    const db = new sqlite3.Database(dbPath, (err) => {
      if (err) {
        reject(new Error(`Failed to open database: ${err.message}`));
        return;
      }
      
      // 开始事务
      db.serialize(() => {
        db.run('BEGIN TRANSACTION');
        
        // 更新认证token
        db.run(
          `INSERT OR REPLACE INTO ItemTable (key, value) VALUES (?, ?)`,
          ['codeium.auth.token', encryptValue(accountInfo.token)],
          (err) => {
            if (err) console.error('Failed to update token:', err);
          }
        );
        
        // 更新刷新token
        db.run(
          `INSERT OR REPLACE INTO ItemTable (key, value) VALUES (?, ?)`,
          ['codeium.auth.refreshToken', encryptValue(accountInfo.refresh_token)],
          (err) => {
            if (err) console.error('Failed to update refresh token:', err);
          }
        );
        
        // 更新用户邮箱
        db.run(
          `INSERT OR REPLACE INTO ItemTable (key, value) VALUES (?, ?)`,
          ['codeium.user.email', accountInfo.email],
          (err) => {
            if (err) console.error('Failed to update email:', err);
          }
        );
        
        // 更新用户名
        db.run(
          `INSERT OR REPLACE INTO ItemTable (key, value) VALUES (?, ?)`,
          ['codeium.user.name', accountInfo.name],
          (err) => {
            if (err) console.error('Failed to update name:', err);
          }
        );
        
        // 更新许可证状态
        db.run(
          `INSERT OR REPLACE INTO ItemTable (key, value) VALUES (?, ?)`,
          ['windsurf.license.status', 'active'],
          (err) => {
            if (err) console.error('Failed to update license status:', err);
          }
        );
        
        // 设置试用期为未来很远的时间
        db.run(
          `INSERT OR REPLACE INTO ItemTable (key, value) VALUES (?, ?)`,
          ['windsurf.trial.expiresAt', '9999999999999'],
          (err) => {
            if (err) console.error('Failed to update trial expiry:', err);
          }
        );
        
        // 提交事务
        db.run('COMMIT', (err) => {
          if (err) {
            db.run('ROLLBACK');
            reject(err);
          } else {
            resolve();
          }
        });
      });
      
      // 关闭数据库连接
      db.close();
    });
  });
}

/**
 * 加密值（使用简单的Base64，实际可能使用AES）
 * @param {string} value - 原始值
 * @returns {string} 加密后的值
 */
function encryptValue(value) {
  // 实际实现可能使用AES-256-GCM
  // 这里简化为Base64
  return Buffer.from(value).toString('base64');
}

/**
 * 更新JSON配置文件
 * @param {string} configDir - 配置目录
 * @param {Object} accountInfo - 账号信息
 */
async function updateJsonConfiguration(configDir, accountInfo) {
  const fs = require('fs').promises;
  const path = require('path');
  
  // 配置文件路径
  const settingsPath = path.join(configDir, 'User', 'settings.json');
  
  try {
    // 读取现有配置
    let settings = {};
    try {
      const content = await fs.readFile(settingsPath, 'utf8');
      settings = JSON.parse(content);
    } catch (err) {
      // 文件不存在，创建新的
      console.log('Settings file not found, creating new one');
    }
    
    // 更新账号相关配置
    settings['codeium.auth'] = {
      email: accountInfo.email,
      name: accountInfo.name,
      lastUsed: Date.now()
    };
    
    // 写回文件
    await fs.writeFile(
      settingsPath,
      JSON.stringify(settings, null, 2),
      'utf8'
    );
    
    console.log('Settings updated successfully');
  } catch (error) {
    console.error('Failed to update settings:', error);
    throw error;
  }
}

/**
 * 更新扩展内部状态
 * @param {Object} accountInfo - 账号信息
 */
async function updateExtensionState(accountInfo) {
  // 获取扩展上下文（在activate函数中传入）
  const context = getExtensionContext();
  
  // 使用SecretStorage存储敏感信息
  await context.secrets.store(
    'windsurf-vip.token',
    accountInfo.token
  );
  
  await context.secrets.store(
    'windsurf-vip.refreshToken',
    accountInfo.refresh_token
  );
  
  // 使用GlobalState存储账号列表
  let accounts = context.globalState.get('accounts', []);
  
  // 更新或添加账号
  const existingIndex = accounts.findIndex(
    acc => acc.email === accountInfo.email
  );
  
  if (existingIndex !== -1) {
    accounts[existingIndex] = {
      ...accounts[existingIndex],
      ...accountInfo,
      active: true,
      lastUsed: Date.now()
    };
    
    // 将其他账号标记为非活跃
    accounts.forEach((acc, idx) => {
      if (idx !== existingIndex) {
        acc.active = false;
      }
    });
  } else {
    // 新账号，添加到列表
    accounts.push({
      ...accountInfo,
      active: true,
      addedAt: Date.now(),
      lastUsed: Date.now()
    });
  }
  
  // 保存账号列表
  await context.globalState.update('accounts', accounts);
  
  // 记录当前活跃账号
  await context.globalState.update('currentAccount', accountInfo.email);
  
  console.log('Extension state updated');
}

/**
 * 同步到远程服务器
 * @param {Object} accountInfo - 账号信息
 */
async function syncToRemoteServer(accountInfo) {
  const https = require('https');
  
  const postData = JSON.stringify({
    email: accountInfo.email,
    lastSwitched: Date.now(),
    platform: process.platform,
    version: getExtensionVersion()
  });
  
  const options = {
    hostname: 'api.example.com', // 实际API地址被混淆
    port: 443,
    path: '/api/v1/accounts/sync',
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Content-Length': Buffer.byteLength(postData),
      'Authorization': `Bearer ${accountInfo.token}`
    }
  };
  
  return new Promise((resolve, reject) => {
    const req = https.request(options, (res) => {
      let data = '';
      
      res.on('data', (chunk) => {
        data += chunk;
      });
      
      res.on('end', () => {
        if (res.statusCode === 200) {
          console.log('Sync successful:', data);
          resolve(JSON.parse(data));
        } else {
          console.error('Sync failed:', res.statusCode, data);
          reject(new Error(`Sync failed: ${res.statusCode}`));
        }
      });
    });
    
    req.on('error', (error) => {
      console.error('Sync error:', error);
      reject(error);
    });
    
    req.write(postData);
    req.end();
  });
}

/**
 * 重新加载Windsurf窗口
 */
async function reloadWindsurf() {
  const vscode = require('vscode');
  
  // 方式1: 使用VS Code命令重载窗口
  await vscode.commands.executeCommand('workbench.action.reloadWindow');
  
  // 方式2: 发送IPC消息（如果Windsurf支持）
  // sendIPCMessage('window.reload');
}

/**
 * 显示成功消息
 */
function showSuccessMessage(message) {
  const vscode = require('vscode');
  vscode.window.showInformationMessage(message);
}

/**
 * 显示错误消息
 */
function showErrorMessage(message) {
  const vscode = require('vscode');
  vscode.window.showErrorMessage(message);
}

/**
 * 获取扩展版本
 */
function getExtensionVersion() {
  const vscode = require('vscode');
  const extension = vscode.extensions.getExtension('wbwb.windsurf-vip');
  return extension ? extension.packageJSON.version : 'unknown';
}

/**
 * 获取扩展上下文（全局变量）
 */
let extensionContext;
function getExtensionContext() {
  return extensionContext;
}
function setExtensionContext(context) {
  extensionContext = context;
}
```

---

## 🗄️ 数据库修改详解

### SQLite数据库结构

```sql
-- state.vscdb 数据库表结构
CREATE TABLE ItemTable (
  key TEXT PRIMARY KEY,    -- 键名
  value TEXT               -- 值（可能加密）
);

-- 示例数据
-- 修改前
SELECT * FROM ItemTable WHERE key LIKE 'codeium%' OR key LIKE 'windsurf%';
/*
key                          | value
-----------------------------|---------------------------
codeium.auth.token           | eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
codeium.auth.refreshToken    | eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
codeium.user.email           | user1@example.com
codeium.user.name            | User One
windsurf.license.status      | trial
windsurf.trial.expiresAt     | 1735660800000
*/

-- 修改后（切换到账号2）
/*
key                          | value
-----------------------------|---------------------------
codeium.auth.token           | eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9... (新token)
codeium.auth.refreshToken    | eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9... (新refresh_token)
codeium.user.email           | user2@example.com        (新邮箱)
codeium.user.name            | User Two                 (新名称)
windsurf.license.status      | active                   (激活状态)
windsurf.trial.expiresAt     | 9999999999999            (远期过期时间)
*/
```

### 具体修改的SQL语句

```sql
-- 账号切换时执行的SQL语句序列

-- 1. 开始事务
BEGIN TRANSACTION;

-- 2. 更新认证token（关键！）
INSERT OR REPLACE INTO ItemTable (key, value) 
VALUES ('codeium.auth.token', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ1c2VyMkBleGFtcGxlLmNvbSIsImlhdCI6MTczNTY2MDgwMCwiZXhwIjoxNzM1NzQ3MjAwfQ.xxxxx');

-- 3. 更新刷新token
INSERT OR REPLACE INTO ItemTable (key, value) 
VALUES ('codeium.auth.refreshToken', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ1c2VyMkBleGFtcGxlLmNvbSIsInR5cCI6InJlZnJlc2giLCJpYXQiOjE3MzU2NjA4MDB9.yyyyy');

-- 4. 更新用户邮箱
INSERT OR REPLACE INTO ItemTable (key, value) 
VALUES ('codeium.user.email', 'user2@example.com');

-- 5. 更新用户名
INSERT OR REPLACE INTO ItemTable (key, value) 
VALUES ('codeium.user.name', 'User Two');

-- 6. 激活许可证（绕过试用限制）
INSERT OR REPLACE INTO ItemTable (key, value) 
VALUES ('windsurf.license.status', 'active');

-- 7. 设置远期过期时间
INSERT OR REPLACE INTO ItemTable (key, value) 
VALUES ('windsurf.trial.expiresAt', '9999999999999');

-- 8. 可能还修改其他键
INSERT OR REPLACE INTO ItemTable (key, value) 
VALUES ('windsurf.features.aiAssist', 'true');

INSERT OR REPLACE INTO ItemTable (key, value) 
VALUES ('windsurf.features.cascadeMode', 'true');

-- 9. 提交事务
COMMIT;
```

---

## 📝 JSON配置文件修改

### settings.json 修改

```json
// 修改前
{
  "workbench.colorTheme": "Default Dark+",
  "editor.fontSize": 14,
  "codeium.auth": {
    "email": "user1@example.com",
    "name": "User One",
    "lastUsed": 1735574400000
  }
}

// 修改后（切换到账号2）
{
  "workbench.colorTheme": "Default Dark+",
  "editor.fontSize": 14,
  "codeium.auth": {
    "email": "user2@example.com",        // ← 修改
    "name": "User Two",                  // ← 修改
    "lastUsed": 1735660800000            // ← 更新时间戳
  }
}
```

### accounts.json (扩展自己维护)

```json
{
  "version": "1.0.5",
  "currentAccount": "user2@example.com",  // ← 标记当前活跃账号
  "lastSwitched": 1735660800000,
  "accounts": [
    {
      "id": "acc-001",
      "email": "user1@example.com",
      "name": "User One",
      "token": "eyJhbGc...",                // 加密存储
      "refresh_token": "eyJhbGc...",
      "addedAt": 1735574400000,
      "lastUsed": 1735574400000,
      "active": false,                     // ← 非活跃
      "expiresAt": 1767196800000
    },
    {
      "id": "acc-002",
      "email": "user2@example.com",
      "name": "User Two",
      "token": "eyJhbGc...",
      "refresh_token": "eyJhbGc...",
      "addedAt": 1735660800000,
      "lastUsed": 1735660800000,
      "active": true,                      // ← 当前活跃
      "expiresAt": 1767283200000
    }
  ]
}
```

---

## 🔄 修改算法流程图

```
                        [用户点击切换按钮]
                               │
                               ▼
                    ┌──────────────────────┐
                    │  获取目标账号信息    │
                    │  • email             │
                    │  • token             │
                    │  • refresh_token     │
                    └──────────┬───────────┘
                               │
                               ▼
                    ┌──────────────────────┐
                    │ 确定配置目录路径      │
                    │ Windows: %APPDATA%   │
                    │ macOS: ~/Library/... │
                    │ Linux: ~/.config/... │
                    └──────────┬───────────┘
                               │
                ┌──────────────┴──────────────┐
                │                             │
                ▼                             ▼
   ┌─────────────────────┐       ┌─────────────────────┐
   │ 修改SQLite数据库    │       │  修改JSON配置文件   │
   │ state.vscdb         │       │  settings.json      │
   └──────────┬──────────┘       └──────────┬──────────┘
              │                              │
              │  INSERT OR REPLACE          │  JSON.stringify()
              │  - codeium.auth.token       │  - codeium.auth: {}
              │  - codeium.user.email       │
              │  - windsurf.license.status  │
              │  - windsurf.trial.expiresAt │
              │                              │
              └──────────┬───────────────────┘
                         │
                         ▼
            ┌─────────────────────────┐
            │ 更新扩展内部状态         │
            │ • context.secrets.store │
            │ • context.globalState   │
            └────────────┬────────────┘
                         │
                         ▼
            ┌─────────────────────────┐
            │ 发送网络请求同步         │
            │ POST /api/accounts/sync │
            └────────────┬────────────┘
                         │
                         ▼
            ┌─────────────────────────┐
            │ 触发窗口重载             │
            │ workbench.action.reload │
            └────────────┬────────────┘
                         │
                         ▼
            ┌─────────────────────────┐
            │ Windsurf重新启动         │
            │ 读取新的token            │
            │ 显示新账号信息           │
            └────────────┬────────────┘
                         │
                         ▼
                   [切换完成]
```

---

## 🎯 关键代码定位

### Webview → Extension 消息传递

```javascript
// webview/account.js (前端)
// 用户点击切换按钮时
document.querySelector('.btn-switch').addEventListener('click', (e) => {
  const accountId = e.target.dataset.accountId;
  const accountInfo = getAccountById(accountId);
  
  // 发送消息给扩展后端
  vscode.postMessage({
    command: 'switchAccount',
    data: accountInfo
  });
});

// extension.js (后端)
// 接收webview消息
webviewView.webview.onDidReceiveMessage(async (message) => {
  if (message.command === 'switchAccount') {
    try {
      await switchAccount(message.data);
      
      // 通知前端切换成功
      webviewView.webview.postMessage({
        command: 'accountSwitched',
        success: true,
        account: message.data
      });
    } catch (error) {
      webviewView.webview.postMessage({
        command: 'accountSwitched',
        success: false,
        error: error.message
      });
    }
  }
});
```

---

## 🔐 Token加密/解密

### 加密算法（推测）

```javascript
const crypto = require('crypto');

// 加密函数（AES-256-GCM）
function encryptToken(token, masterKey) {
  const algorithm = 'aes-256-gcm';
  const iv = crypto.randomBytes(16);  // 初始化向量
  const key = crypto.scryptSync(masterKey, 'salt', 32);  // 派生密钥
  
  const cipher = crypto.createCipheriv(algorithm, key, iv);
  
  let encrypted = cipher.update(token, 'utf8', 'hex');
  encrypted += cipher.final('hex');
  
  const authTag = cipher.getAuthTag();
  
  // 返回格式: iv:authTag:encrypted
  return `${iv.toString('hex')}:${authTag.toString('hex')}:${encrypted}`;
}

// 解密函数
function decryptToken(encryptedToken, masterKey) {
  const algorithm = 'aes-256-gcm';
  const parts = encryptedToken.split(':');
  
  const iv = Buffer.from(parts[0], 'hex');
  const authTag = Buffer.from(parts[1], 'hex');
  const encrypted = parts[2];
  const key = crypto.scryptSync(masterKey, 'salt', 32);
  
  const decipher = crypto.createDecipheriv(algorithm, key, iv);
  decipher.setAuthTag(authTag);
  
  let decrypted = decipher.update(encrypted, 'hex', 'utf8');
  decrypted += decipher.final('utf8');
  
  return decrypted;
}

// 使用示例
const masterKey = 'windsurf-vip-master-key-2025';  // 实际密钥被混淆
const token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...';

const encrypted = encryptToken(token, masterKey);
console.log('Encrypted:', encrypted);
// 输出: a3f8c9d4e5f6a7b8:1234567890abcdef:9f8e7d6c5b4a3210...

const decrypted = decryptToken(encrypted, masterKey);
console.log('Decrypted:', decrypted);
// 输出: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

---

## 📊 修改前后对比表

| 项目 | 修改前 | 修改后 | 修改方式 |
|------|--------|--------|----------|
| **数据库 state.vscdb** | | | |
| codeium.auth.token | user1的token | user2的token | `INSERT OR REPLACE` |
| codeium.auth.refreshToken | user1的refresh_token | user2的refresh_token | `INSERT OR REPLACE` |
| codeium.user.email | user1@example.com | user2@example.com | `INSERT OR REPLACE` |
| codeium.user.name | User One | User Two | `INSERT OR REPLACE` |
| windsurf.license.status | trial | active | `INSERT OR REPLACE` |
| windsurf.trial.expiresAt | 1735660800000 | 9999999999999 | `INSERT OR REPLACE` |
| **配置文件 settings.json** | | | |
| codeium.auth.email | user1@example.com | user2@example.com | JSON覆盖 |
| codeium.auth.name | User One | User Two | JSON覆盖 |
| codeium.auth.lastUsed | 1735574400000 | 1735660800000 | JSON覆盖 |
| **扩展存储** | | | |
| context.secrets (token) | user1 token | user2 token | `secrets.store()` |
| context.globalState (currentAccount) | user1@example.com | user2@example.com | `globalState.update()` |

---

## 🧪 测试验证

### 如何验证账号切换是否成功

```javascript
/**
 * 验证账号切换结果
 */
async function verifyAccountSwitch(expectedEmail) {
  const path = require('path');
  const sqlite3 = require('sqlite3');
  
  const configDir = getWindsurfConfigDirectory();
  const dbPath = path.join(configDir, 'User', 'globalStorage', 'state.vscdb');
  
  return new Promise((resolve, reject) => {
    const db = new sqlite3.Database(dbPath, sqlite3.OPEN_READONLY, (err) => {
      if (err) {
        reject(err);
        return;
      }
      
      db.get(
        'SELECT value FROM ItemTable WHERE key = ?',
        ['codeium.user.email'],
        (err, row) => {
          if (err) {
            reject(err);
          } else if (row && row.value === expectedEmail) {
            console.log('✅ Account switch verified!');
            resolve(true);
          } else {
            console.log('❌ Account switch failed!');
            console.log('Expected:', expectedEmail);
            console.log('Found:', row ? row.value : 'NULL');
            resolve(false);
          }
          
          db.close();
        }
      );
    });
  });
}

// 使用示例
switchAccount(account2Info)
  .then(() => verifyAccountSwitch('user2@example.com'))
  .then(success => {
    if (success) {
      console.log('Account switched successfully!');
    } else {
      console.log('Account switch verification failed!');
    }
  });
```

---

## 📌 总结

### 核心修改点

1. **SQLite数据库 state.vscdb**
   - 修改键: `codeium.auth.token`, `codeium.auth.refreshToken`, `codeium.user.email`
   - 修改方法: `INSERT OR REPLACE INTO ItemTable`
   - 修改行数: 6-10行

2. **JSON配置 settings.json**
   - 修改对象: `codeium.auth`
   - 修改方法: 读取→解析→修改→序列化→写回
   - 修改格式: JSON

3. **扩展内部存储**
   - VS Code SecretStorage API
   - VS Code GlobalState API
   - 修改方法: 异步API调用

### 修改算法特点

- **原子性**: 使用事务确保数据一致性
- **加密性**: 敏感信息加密存储
- **持久性**: 写入磁盘文件
- **跨平台**: 自动适配不同操作系统路径
- **无权限**: 不需要管理员权限（仅修改用户空间文件）

### 安全警告

⚠️ 此技术分析仅供学习研究，实际使用存在以下风险：
- 违反软件许可协议
- 可能被封禁账号
- 存在安全漏洞
- 影响软件稳定性

**建议使用正版软件！**
